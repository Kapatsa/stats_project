---
title: "Развитие стран мира и экономика — анализ данных"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css, echo=FALSE}
.spoiler {
  visibility: hidden;
}

.spoiler::before {
  visibility: visible;
  content: "Spoiler alert! Hover me to see the answer."
}

.spoiler:hover {
  visibility: visible;
}

.spoiler:hover::before {
  display: none;
}
```

### Команда

1. Дейвид Капаца

2. Григорий Макаров

### Введение

Данный отчёт представляет из себя результат работы по анализу данных датасета `GrowthDJ`, который доступен по следующей  [ссылке](https://vincentarelbundock.github.io/Rdatasets/articles/data.html).

Сразу же запишем этот датасет в датафрейм `df` и покажем начало таблицы:
```{r}
df <- read.csv("GrowthDJ.csv")
head(df)
```

#### Кoрoтко о данных

Это данные от 1992 года, в качестве индивидов выступают государства (121), в качестве признаков — различные социоэкономические показатели (10). 

1. `oil`
factor. Is the country an oil-producing country?

2. `inter`
factor. Does the country have better quality data?

3. `oecd`
factor. Is the country a member of the OECD? (Организация экономического сотрудничества и развития)

4. `gdp60`
Per capita GDP in 1960.

5. `gdp85`
Per capita GDP in 1985.

6. `gdpgrowth`
Average growth rate of per capita GDP from 1960 to 1985 (in percent).

7. `popgrowth`
Average growth rate of working-age population 1960 to 1985 (in percent).

8. `invest`
Average ratio of investment (including Government Investment) to GDP from 1960 to 1985 (in percent).

9. `school`
Average fraction of working-age population enrolled in secondary school from 1960 to 1985 (in percent).

10. `literacy60`
Fraction of the population over 15 years old that is able to read and write in 1960 (in percent).

Так как датасет состоит во многом из экономических данных, наверняка появится желание прологарифмировать некоторые наблюдения, но это потом.

## Первичный анализ данных

### Описательная статистика

```{r}
summary(df)
```

### Виды признаков

Таблица внизу показывает, какую моду имеют наши количественные признаки. Отсюда можно сделать вывод о том, являются они непрерывными или нет.

```{r}
library(dplyr)
summarize(df, across(gdp60:literacy60, function(x) max(table(x))))
```

1. `oil` качественный

2. `inter` качественный

3. `oecd` качественный

4. `gdp60` количественный почти непрерывный

5. `gdp85` количественный почти непрерывный

6. `gdpgrowth` количественный дискретный

7. `popgrowth` количественный дискретный

8. `invest` количественный дискретный

9. `school` количественный дискретный

10. `literacy60` количественный дискретный


## Matrix plot

Сразу же построим matrix plot для того, чтобы увидеть особенности в наших данных.

```{r}
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "orange", ...)
}

pairs(~ gdp60 + gdp85 + gdpgrowth + invest + school, data = df, diag.panel = panel.hist, pch = 19,  cex = 0.5)
```

Хорошо видно по гистограммам, что для дальнейшего анализа надо логарифмировать показатели ВВП. Сделаем именно это:

```{r}
pairs(~ log(gdp60) + log(gdp85) + gdpgrowth + invest + school, data = df, diag.panel = panel.hist, pch = 19,  cex = 0.5)
```

Стало лучше.


### Аутлаеры

Видим очевидный аутлаер по признаку `gdp60`. Его можно заметить и по признаку `gdp60`.

```{r}
which.max(df$gdp60)
which.max(df$gdp85)
```

Оказывается, что такой высокий показатель ВВП на душу населения наблюдался в Кувейте, одном из крупнейших экспортёров нефти. Уберём его для дальнейшего анализа.

```{r}
df <- df[-56,]
```


### Неоднородности

#### Нефть

Мы предположили, что страны, которые добывают нефть, должны в целом положительным образом отличаться от других.

```{r}
my_cols <- c("light blue", "orange")
pairs(~ log(gdp60) + log(gdp85) + gdpgrowth + invest + school, data = df, col = my_cols[df$oil], pch = 19,  cex = 0.5, oma=c(3,3,6,8))
par(xpd = TRUE)
legend("bottomright", legend = c("no oil", "oil"), col = my_cols, pch = 19,  cex = 0.5)
title("Matrix Plot (group by oil)")
```

Однако, при делении данных по фактору "нефть", сложно установить неоднородность данных. Можно предположить, что наличие/отсутствие нефти не влияет на данные экономические показатели. 

#### Участие в ОЭСР

ОЭСР — это крупная международная организация, которая была создана для поддержки плана Маршалла для восстановления Западной Европы после Второй Мировой, поэтому ожидаем разницу в соответствующих условных распределениях.

```{r}
pairs(~ log(gdp60) + log(gdp85) + gdpgrowth + invest + school, data = df, col = my_cols[df$oecd], pch = 19,  cex = 0.5, oma=c(3,3,6,10.5))
par(xpd = TRUE)
legend("bottomright", legend = c("non-member", "member"), col = my_cols, pch = 19,  cex = 0.5)
title("Matrix Plot (group by OECD membership)")
```

Данную неоднородность можно объяснить тем, что в ОЭСР входят развитые европейские страны из-за чего мы можем наблюдать достаточно высокие показатели ВВП в этой группе.

#### Качество данных

```{r}
pairs(~ log(gdp60) + log(gdp85) + gdpgrowth + invest + school, data = df, col = my_cols[df$inter], pch = 19,  cex = 0.5, oma=c(3,3,6,10))
par(xpd = TRUE)
legend("bottomright", legend = c("poor quality", "good quality"), col = my_cols, pch = 19,  cex = 0.5)
title("Matrix Plot (group by quality of data)")
```

По данному matrix plot можно сделать предположение, что наблюдается однородность данных по признаку "inter", что в свою очередь означает, что в общем все данные репрезентативные. (Аутлаер, как можно заметить, входит в "poor quality").

```{r}
library(psych)
df_for_cor <- data.frame( "ln_gdp60"     = log(df$gdp60), 
                          "ln_gdp85"     = log(df$gdp85), 
                          "gdpgrowth" = df$gdpgrowth,
                          "invest"    = df$invest,
                          "school"    = df$school)

ind_60 <- which.max(df_for_cor$ln_gdp60)
ind_85 <- which.max(df_for_cor$ln_gdp85)
df_for_cor$ln_gdp60[ind_60] <- NA
df_for_cor$ln_gdp85[ind_85] <- NA

pairs.panels(df_for_cor, 
             method = "pearson", 
             hist.col = "orange",
             density = TRUE,
             ellipses = FALSE,
             lm = TRUE,
             stars = TRUE
             )
```

1. Между ВВП на душу населения в 1960 и средним отношением инвестиций наблюдается корреляция с коэфицентом 0.58.
Между ВВП на душу населения в 1985 и средним отношением инвестиций наблюдается корреляция с коэфицентом 0.71.
Чем больше инвестируют в страну, тем больше она производит и тем больше ВВП.


2. Так же показатели ВВП хорошо коррелируют со средней долей населения трудоспособного возраста, посещавшего среднюю школу.


### О виде распределений и о сравнении распределений

**План:**

1. Сравнение распределений: ящики с усами, гистограммы, критерии нормальности *(Григорий Макаров)*

2. Сравнение распределений: сравнение групп, форма распределений, парные критерии *(Дейвид Капаца)*

#### Выбор категоризующей переменной
_Выберите в данных категоризующую переменную. По ней выборка разбивается на подвыборки (например, случай, когда вы увидели неоднородность при первичном анализе, но необязательно)._

После проведённого первичного анализа наблюдалась неоднородность по признаку "Участие в ОЭСР". Разбивать данные будем по этому признаку. 

#### Сравнение распределений: ящики с усами
_Сначала имеет смысл посмотреть на сравнение сравнение распределений в группах с помощью ящиков с усами (box plot). С помощью ящиков с усами там, где групп больше двух, можно выбрать две из них, которые интересно сравнить с помощью критериев._

Для первичного сравнения распределений посмотрим на ящики с усами, которые дадут первоначальное представление о разнице в распределениях по категоризующей переменной.

##### Изменение ВВП

Построим box плоты для значений ВВП на душу населения в 1960 и 1985 годах, с категоризацией по членству в ОЭСР.
Предполагаем, что членство в ОЭСР способствует более согласованному росту ВВП среди стран-участниц за счёт совместных договорённостей и взаимопомощи уже достаточно развитых государств.

```{r, echo = FALSE}
par(mfrow=c(1,2))

boxplot(log(gdp60)~oecd,
data=df,
main="GDP in 1960",
xlab="membership in oecd",
ylab="log GDP (per capita)",
ylim = c(6, 10),
col="orange",
border="brown"
)

boxplot(log(gdp85)~oecd,
data=df,
main="GDP in 1985",
xlab="membership in oecd",
ylab="log GDP (per capita)",
ylim = c(6, 10),
col="orange",
border="brown"
)
```

Из ящиков с усами действительно видим, что членство в организации действительно приводит к уменьшению межквартильного размаха и предположительному росту ВВП в среднем. 

В свою очередь у оставшихся стран на первый взгляд такой сходимости не наблюдается.

##### Образование

Так как нам заведомо известно, что страны ОЭСР достаточно развитые, можем ожидать в среднем более высокую долю обучающихся в средней школе, а также меньший разброс.

```{r, echo = FALSE}
boxplot(school~oecd,
data=df,
main="Secondary school enrollment",
xlab="membership in oecd",
ylab="fraction",
col="orange",
border="brown"
)
```

Наши предположения в целом подтверждаются графиком сверху.


Так что на первый взгляд можно предположить, что наблюдаются отличия во всех сравнениях.

#### Нормальность признаков: визуально и критерии

_Проверьте, близко ли распределение выбранных признаков к нормальному. Можно использовать различные критерии для проверки этой гипотезы, можно рисовать normal probability plot._

Построим гистограммы и qqplotы распределений по группам: 

##### Нормальность ВВП: визуально

```{r, echo = FALSE}
par(mfrow=c(2,2))
hist(log(df$gdp60[which(df$oecd=="yes")]), col= "light green", main = "1960", xlab = "log GDP (per capita)")
hist(log(df$gdp85)[which(df$oecd=="yes")], col= "light green", main = "1985", xlab = "log GDP (per capita)")
title("oecd members", line = -1, outer = TRUE)
hist(log(df$gdp60[which(df$oecd=="no")]), col= "orange", main = "1960", xlab = "log GDP (per capita)")
hist(log(df$gdp85)[which(df$oecd=="no")], col= "orange", main = "1985", xlab = "log GDP (per capita)")
title("non-oecd members", line = -14, outer = TRUE)
```

Членов ОЭСР достаточно мало (22), поэтому гистограмма для них выглядит не очень убедительно.
Видим для не членов некоторую симметричность, насчёт нормальности уверенности нет.

```{r, echo = FALSE}
par(mfrow=c(2,2))
qqnorm(log(df$gdp60[which(df$oecd=="yes")]), pch = 1, frame = FALSE, col= "black", main = "1960")

qqline(log(df$gdp60[df$oecd == "yes"]), col = "steelblue", lwd = 2)

qqnorm(log(df$gdp85)[which(df$oecd=="yes")],pch = 1, frame = FALSE, col= "black", main = "1985")

qqline(log(df$gdp85[df$oecd == "yes"]), col = "steelblue", lwd = 2)

title("oecd members", line = -1, outer = TRUE)
qqnorm(log(df$gdp60[which(df$oecd=="no")]), pch = 1, frame = FALSE,col= "orange", main = "1960")

qqline(log(df$gdp60[df$oecd == "no"]), col = "steelblue", lwd = 2)

qqnorm(log(df$gdp85)[which(df$oecd=="no")],pch = 1, frame = FALSE, col= "orange", main = "1985")

qqline(log(df$gdp85[df$oecd == "no"]), col = "steelblue", lwd = 2)

title("non-oecd members", line = -14, outer = TRUE)
```

Построив Normal Probability Plot, видим аналогичные результаты.


Теперь воспользуемся критериями для проверки распределений на нормальность.

##### Нормальность ВВП + Инвестиции + Образование: критерии

*Критерий Шапиро-Уилка*

```{r, echo = FALSE}
shapiro.test(log(df$gdp60[df$oecd == "yes"]))
shapiro.test(log(df$gdp60[df$oecd == "no"]))

shapiro.test(log(df$gdp85[df$oecd == "yes"]))
shapiro.test(log(df$gdp85[df$oecd == "no"]))

shapiro.test(df$invest[df$oecd == "yes"])
shapiro.test(df$invest[df$oecd == "no"])

shapiro.test(df$school[df$oecd == "yes"])
shapiro.test(df$school[df$oecd == "no"])
```


*Критерий согласия Пирсона (Хи-квадрат)*


```{r, echo = FALSE}
library(nortest)

pearson.test(log(df$gdp60[df$oecd == "yes"]))
pearson.test(log(df$gdp60[df$oecd == "no"]))

pearson.test(log(df$gdp85[df$oecd == "yes"]))
pearson.test(log(df$gdp85[df$oecd == "no"]))

pearson.test(df$invest[df$oecd == "yes"])
pearson.test(df$invest[df$oecd == "no"])

pearson.test(df$school[df$oecd == "yes"])
pearson.test(df$school[df$oecd == "no"])
```

Сгенeрируем таблицу p-value тестов для **группы, входящей в ОЭСР**:


```{r, echo = FALSE}

table_p <- data.frame(Data = c("log(gdp60))", "log(gdp85))","invest", "school"),
                      Sh_W = c(0.01498, 0.005064, 0.476, 0.2493 ),
                      Pearson = c(0.0436, 0.008551,0.5887,0.9233)
)

table_p

```


По полученным результатам можно сделать следующие выводы:

1. Мы отвергаем гипотезу о нормальном распределении следующих признаков: log(gdp60)) и log(gdp85))

2. Нет оснований отвергнуть гипотезу о нормальном распределении признаков: invest и school


Теперь таблица p-value тестов для **группы, не входящей в ОЭСР**:


```{r, echo = FALSE}

table_pp <- data.frame(Data = c("log(gdp60))", "log(gdp85))","invest", "school"),
                      Sh_W = c(0.07117, 0.0339 , 0.00558,0.0000747  ),
                      Pearson = c(0.1893, 0.0093 ,0.3148 ,0.00071 )
)

table_pp

```


#### Сравнение групп: критерии

*Сравните группы между собой. Можно сравнить по разным критериям, например, критерий t-test, который умеет обнаруживать разницу в среднем. Непараметрический аналог, с помощью которого можно обнаруживать сдвиг - критерий Манна-Уитни/Вилкоксона.*

Условием применения t-test считается близость к нормальному распределению, однако при достаточно больших $n$ можем использовать его как асимптотический критерий. Ввиду неплохой симметричности рассмотренных распределений можем считать, что медиана и среднее близки, поэтому будем рассматривать t-test и Mann-Whitney вместе. Известно, что при нормальности данных результаты применения тестов должны совпадать.

**ВВП в 1985 году**
```{r, echo = FALSE}
t.test(log(gdp85) ~ oecd, data = df)
wilcox.test(log(gdp85) ~ oecd, data = df)
```
Отвергаем гипотезы о равенстве средних и медиан.

**Инвестиции**

```{r, echo = FALSE}
t.test(invest ~ oecd, data = df)
wilcox.test(invest ~ oecd, data = df)
```

И здесь отвергаем, как и предполагалось.

**Образование**

```{r, echo = FALSE}
t.test(school ~ oecd, data = df)
wilcox.test(school ~ oecd, data = df)
```

Здесь тоже. В целом можем предположить, что принадлежность к ОЭСР помогает странам развиваться согласованно во многих направлениях.

#### Сравнение групп: форма распределений
*Но распределения могут отличаться не только сдвигом. Рассмотрите критерий Колмогорова-Смирнова, который может обнаружить, если распределения отличаются формой.*

**ВВП в 1985**

Хотелось бы, чтобы отверглось, но КС тест достаточно консервативен, поэтому статистически значимые результаты мы получаем реже, чем предполагается заданным уровнем значимости.
```{r, echo = FALSE}
par(mfrow=c(1,2))
ks.test(log(df$gdp85[df$oecd == "yes"]), log(df$gdp85[df$oecd == "no"]))
```
Всё как и хотелось, отвергаем при любых стандартных уровнях значимости. А если отвергли с КС, "то уж точно" отвергаем.

#### Парные критерии

*Если есть признаки, которые характеризуют одно и то же (например, время, которое человек тратит на сон, и время на работу), то аналогично производится сравнение по t-критерию и по непараметрическим критериям, они называются парными.*


```{r}
not_na <- !(is.na(df$gdp60) | is.na(df$gdp85))
t.test(log(df$gdp60[not_na]), y = log(df$gdp85[not_na]))
t.test(log(df$gdp60[not_na]), y = log(df$gdp85[not_na]), paired = TRUE)
```

### Aнализ зависимостей и их первичное исследование

**План:**

1. Анализ зависимостей: первичный поиск зависимостей, критерий Пирсона *(Дейвид Капаца)*

2. Анализ зависимостей: критерий Спирмена, сравнительный анализ *(Григорий Макаров)*

*Вспомните, какие бывают виды зависимостей и чем они измеряются, по каким формулам. Посмотрите на основе matrix plot, какие зависимости у вас в данных. Не забудьте, что при неоднородных данных изучать зависимости имеет смысл только внутри групп по-отдельности.*

*Начинать нужно с анализа линейных зависимостей. На основе коэффициента корреляции Пирсона нужно проинтерпретировать значимые зависимости. При наличие в данных пропусков обратите внимание на выбор между casewise and pairwise MD deletion (в чем разница, какие недостатки и достоинства у этих вариантов?).*

*Замечание:*  везде используем pairwisе, понимая, что соответствующие полученные распределения немного отличаются друг от друга. Если удалять casewise, то удалим уже много стран, а это повлияет на критерии.

Вернёмся к нашему matrix plot, который факторизует по странам, входящим и не входящим в ОЭСР. 

```{r}
pairs(~ log(gdp60) + log(gdp85) + gdpgrowth + invest + school, data = df, col = my_cols[df$oecd], pch = 19,  cex = 0.5, oma=c(3,3,6,10.5))
par(xpd = TRUE)
legend("bottomright", legend = c("non-member", "member"), col = my_cols, pch = 19,  cex = 0.5)
title("Matrix Plot (group by OECD membership)")
```

Посмотрим на график, где отображены корреляции с факторизацией по членству в ОЭСР.

```{r}
#install.packages("Hmisc")
#install.packages("corrplot")
library(Hmisc)
library(corrplot)
par(mfrow=c(1,2))

df_matrix <- as.matrix(df_for_cor)
df_oecd <- df_matrix[which(df$oecd == "yes"),]
df_noecd <- df_matrix[which(df$oecd == "no"),]
res_oecd <- rcorr(df_oecd)
res_noecd <- rcorr(df_noecd)
corrplot(res_oecd$r, type="upper", order="hclust", 
         p.mat = res_oecd$P, sig.level = 0.05, insig = "blank")
title("OECD members")

corrplot(res_noecd$r, type="upper", order="hclust", 
         p.mat = res_noecd$P, sig.level = 0.05, insig = "blank")
title("non-OECD members")
```

Здесь достаточно наглядно показаны значимые ($\alpha = 0.05$) корреляции и их величины. Изучим подробнее некоторые зависимости, которые мы предполагали посмотреть ещё в начале исследования.

1. **Влияние инвестиций на рост ВВП**

Предполагаем, что увеличение инвестиций в страну должно положительным образом влиять на рост ВВП, ведь инвестиции помогают *ускорить* производственные и бизнес-процессы. Также предполагаем, что на более развитые страны увеличение инвестиций на рост ВВП действует не так сильно.

```{r}
cor.test(df$invest[which(df$oecd == "no")], df$gdpgrowth[which(df$oecd == "no")])
```

```{r}
cor.test(df$invest[which(df$oecd == "yes")], df$gdpgrowth[which(df$oecd == "yes")])
```

Действительно, наши предположения в целом оправдываются.
В случае, когда страна не принадлежит организации, гипотеза о равенстве корреляции нулю отвергается при всех стандартных уровнях значимости.
В том же случае, когда страна является членом ОЭСР, гипотеза не отвергается при всех стандартных уровнях значимости, то есть критерий не обнаружил зависимость.

2. **Влияние образованности населения на ВВП в 1985 году**

Так как переменная `school` отвечает за часть работоспособного населения, которая обучается в школе — она связана с уровнем образованности населения. Логично предполагать, что в странах, где люди более образованны, будут более высокие показатели ВВП. Однако в данном случае кажется сложным сказать, что является следствием чего. Изучаем именно 1985 год, так как данные по образованию у нас усреднённые с 1960 по 1985, чтобы увидеть эффект политики.

```{r}
cor.test(df$school[which(df$oecd == "no")], df$gdp85[which(df$oecd == "no")])
```

```{r}
cor.test(df$school[which(df$oecd == "yes")], df$gdp85[which(df$oecd == "yes")])
```

Получив то, что мы получили, а именно:

1. (случай не-ОЭСР) Гипотеза о равенстве корреляции нулю отвергается при всех стандартных уровнях значимости, видим достаточно сильную корреляцию, даже если смотреть на доверительный интервал;

2. (случай ОЭСР) Гипотеза о равенстве корреляций отвергается при всех уровнях значимости, меньших $0.0332$. Доверительный интервал для корреляции имеет достаточно большой разброс, что говорит о том, что нам сложно оценить степень влияния образования на ВВП,

можно предложить такое объяснение. Эффект более заметен на развивающихся странах, так как именно в это время многие из них стали вкладывать свои ресурсы в образование, а у развитых стран уровень образования в целом уже "сошёлся" к какому-то определённому высокому уровню.

Так как образование тоже можно рассматривать как некоторую "инвестицию", можно предполагать зависимость, связывающую образованность и рост ВВП, **но только в случае, когда страны находятся в стадии своего развития**.

```{r}
cor.test(df$school[which(df$oecd == "no")], df$gdpgrowth[which(df$oecd == "no")])
```
```{r}
cor.test(df$school[which(df$oecd == "yes")], df$gdpgrowth[which(df$oecd == "yes")])
```

В принципе, данные результаты подтверждают наши догадки. Для "развивающихся" стран гипотеза отвергается при всех стандартных уровнях значимости. В случае с со странами ОЭСР критерий не нашёл значимого отклонения от гипотезы при всех стандартных уровнях значимости.

3. **Зависимость ВВП в 1960 году и ВВП в 1985 году**

Здесь делаем тривиальное предположение о том, что показатели ВВП в 1960 году положительным образом связаны с соответствующими показателями в 1985 году, причём от класса стран это зависеть не должно. Это можно интерпретировать примерно так: время было в целом мирным, богатые страны оставались богатыми, бедные - бедными, баланс сил не изменился.

```{r}
cor.test(log(df$gdp60[which(df$oecd == "no")]), log(df$gdp85[which(df$oecd == "no")]))
```

```{r}
cor.test(log(df$gdp60[which(df$oecd == "yes")]), df$gdp85[which(df$oecd == "yes")])
```

Действительно, всё похоже.
В обоих случаях видим очень маленькие p-value. Это свидетельствует о том, что гипотеза отвергается при всех стандартных уровнях значимости.

4. **Зависимость ВВП в 1960 году и роста ВВП**

Здесь предполагаемая зависимость похожа на влияние инвестиций на рост ВВП в случае стран ОЭСР: страны _уже_ развитые и рост может "сходиться" к нулю. Если же страна менее развита и/или находится в стадии формирования, предполагаем, что рост ВВП вряд ли будет зависеть от ВВП в "начале пути".

```{r}
cor.test(log(df$gdp60[which(df$oecd == "no")]), log(df$gdpgrowth[which(df$oecd == "no")]))
```

```{r}
cor.test(log(df$gdp60[which(df$oecd == "yes")]), df$gdpgrowth[which(df$oecd == "yes")])
```

Результаты согласованы с предположениями. В случае "развивающихся стран", гипотеза не отвергается при всех стандартных уровнях значимости, то есть зависимость критерием не обнаружена. В случае стран ОЭСР гипотеза о равенстве коэффициента корреляции нулю отвергается, при этом видим, что зависимость отрицательная.

#### Ранговые коэффициенты корреляции

*Затем можно переходить к ранговым коэффициентам корреляции. Расскажите, при каких условиях коэффициенты корреляции Пирсона и Спирмена примерно равны. Приведите примеры, когда один из них больше другого и наоборот. Сравните результаты на ваших данных. Если при сравнении буду найдены заметные различия в результатах, то попробуйте объяснить причину.*


Так как коэффициент корреляции Спирмана является ранговым аналогом коэффициенту Пирсона, то они примерно равны, когда:


1) каждая переменная имеет нормальное распределение


2) гомоскедастичность, дисперсия каждой переменной остается постоянной


3) линейность, то есть точки на скатер плоте распределяются симметрично относительно регрессионной прямой.


1. Пирсон > Спирмена

Так как коэффициент корреляции Пирсона не устойчив к выбросам, то из-за их воздействия коэффициент Пирсона может быть больше.


Так же коэффициент Пирсона может быть больше, если в данных наблюдается хорошая линейная зависимость.


2. Спирмен > Пирсона


Коэффициент Спирмана будет больше, если в данных наблюдается нелинейная монотонность.


Посчитаем коэффициенты Пирсона и Спирмана на наших данных:


1. **Влияние инвестиций на рост ВВП**


```{r}
cor.test(df$invest[which(df$oecd == "no")], df$gdpgrowth[which(df$oecd == "no")])

cor.test(df$invest[which(df$oecd == "no")], df$gdpgrowth[which(df$oecd == "no")], method = "spearman")

plot(df$invest[which(df$oecd == "no")], df$gdpgrowth[which(df$oecd == "no")], main = "oecd = no")
```

Спирмен дает более маленький p-value, так как коэффициент корреляции Пирсона менее устойчив к гетероскедастичности.

```{r}
cor.test(df$invest[which(df$oecd == "yes")], df$gdpgrowth[which(df$oecd == "yes")])

cor.test(df$invest[which(df$oecd == "yes")], df$gdpgrowth[which(df$oecd == "yes")], method = "spearman")

plot(df$invest[which(df$oecd == "yes")], df$gdpgrowth[which(df$oecd == "yes")], main = "oecd = yes")
```


По критерию Спирмена получился более высокий показатель p-value, скорее всего это связано с тем, что коэффициент корреляции Пирсона менее устойчив к выбросам.


2. **Влияние образованности населения на ВВП в 1985 году**

```{r}
cor.test(df$school[which(df$oecd == "no")], df$gdp85[which(df$oecd == "no")])

cor.test(df$school[which(df$oecd == "no")], df$gdp85[which(df$oecd == "no")], method = "spearman")

plot(df$school[which(df$oecd == "no")], df$gdp85[which(df$oecd == "no")], main = "oecd = no")
```

Так как зависимость монотоная и нелинейная, то p-value критерия Спирмана меньше.


```{r}
cor.test(df$school[which(df$oecd == "yes")], df$gdp85[which(df$oecd == "yes")])

cor.test(df$school[which(df$oecd == "yes")], df$gdp85[which(df$oecd == "yes")], method = "spearman")

plot(df$school[which(df$oecd == "yes")], df$gdp85[which(df$oecd == "yes")], main = "oecd = yes")
```

Из-за наличия выбросов критерий Пирсона дает p-value, которое не дает основания принять нулевую гипотезу. А критерий Спирмана напротив не дает оснований отвергнуть нулевую гипотезу о равенстве коэффициента корреляции 0.


3. **Зависимость ВВП в 1960 году и ВВП в 1985 году**


```{r}
cor.test(log(df$gdp60[which(df$oecd == "no")]), log(df$gdp85[which(df$oecd == "no")]))


cor.test(log(df$gdp60[which(df$oecd == "no")]), log(df$gdp85[which(df$oecd == "no")]), method = "spearman")

plot(log(df$gdp60[which(df$oecd == "no")]), log(df$gdp85[which(df$oecd == "no")]), main = "oecd = no")

```

Оба критерия дают одинаковые результаты из-за хорошей линейной зависимости и гомоскедастичности признаков. 


```{r}
cor.test(log(df$gdp60[which(df$oecd == "yes")]), df$gdp85[which(df$oecd == "yes")])


cor.test(log(df$gdp60[which(df$oecd == "yes")]), df$gdp85[which(df$oecd == "yes")], method = "spearman")

plot(log(df$gdp60[which(df$oecd == "yes")]), df$gdp85[which(df$oecd == "yes")], main = "oecd = yes")

```

#### Интерпретация найденных корреляций

*Проинтерпретируйте найденные корреляции - можно ли сказать, что является причиной, что следствием. Если есть какая-то другая причина, которая влияет одновременно на оба признака (скрытый фактор), то попробуйте убрать его влияние с помощью частных корреляций.*



1. **Влияние инвестиций на рост ВВП**


В этом случае нельзя сказать, что является причиной, что следствием.


2. **Влияние образованности населения на ВВП в 1985 году**


Чем образованней население в стране, тем выше ее ВВП. В этом случае ВВП можно считать как следствие.


3. **Зависимость ВВП в 1960 году и ВВП в 1985 году**

Время было в целом мирным, богатые страны оставались богатыми, бедные - бедными, баланс сил не изменился. Поэтому ВВП в 1960 году является причиной.

#### Частные корреляции

TODO:: Гриша, давай попробуем сделать частные корреляции как-то так. 

*Влияют ли инвестиции на ВВП за вычетом роста ВВП?*



### Линейная регрессия

**План:**

1. Члены ОЭСР *(Дейвид Капаца)*

2. Не члены ОЭСР *(Григорий Макаров)*

**Интересно предсказать ВВП в 1985 году с помощью всех остальных переменных.**

#### Члены ОЭСР

```{r}
library(lm.beta)
lm.df.oecd <- lm.beta(lm(data = df[which(df$oecd == "yes"),], log(gdp85) ~ log(gdp60) + gdpgrowth + invest + school))
summary(lm.df.oecd)
```

##### Описание характеристик

На примере первой модели опишем все полученные характеристики.

`Residuals` : Минимальное, максимальное значение, медиана, и 1, 3 квартили $\mathbf y-\mathbf{\hat y}$, где $\mathbf{\hat y}$ --- предсказание по линейной регрессионной модели.

`Coefficients` : 

- `Estimate` : оценка коэффициента регрессии у соответствующего признака, можно использовать для предсказания;

- `Standardized` : оценка коэффициента регрессии при стандартизированных признаках, помогает определеить степень влияния признака;

- `Std. Error` : стандартная ошибка для оценки коэффициента

- `t-value` : значение статистики (проверяем гипотезу о равенстве коэффициента регрессии $0$ - аналогично тому, что корреляция между двумя признаками равна $0$);

- `Pr(>|t|)` : p-value для гипотезы;

`Residual standard error` :  стандартная ошибка для $\mathbf y-\mathbf{\hat y}$;

`degrees of freedom` : в нашем случае $n - k - 1$, где $n$ - число стран ($22$), $k$ - число параметров ($4$);

`Multiple R-squared` : множественный коэффициент корреляции;

`Adjusted R-squared` : множественный коэффициент корреляции со штрафом за число параметров в модели;

`F-statistic` : статистика к гипотезе о том, что регрессия не значима (строится с использованием $R^2$) с числом параметров, числом степеней свободы, и p-value.

##### Интерпретация результатов, выбор модели

Теперь вернемся к интерпретации результатов.
Значимость регрессии по F-statistic хорошая, при любых стандартных уровнях значимости не отвергаем гипотезу о том, что все коэффициенты нулевые. Гипотеза o том, что регрессионная прямая имеет нулевой сдвиг по оси $y$ не отвергается при любых стандартных уровнях значимости. 

Предсказуемо, коэффициент для `log(gdp60)` статистически значим для любого стандартного уровня значимости, также для уровня значимости менее $0.017$ значим коэффициент `gdpgrowth`.

Для членов ОЭСР мы уже показали, что признаки `gdpgrowth` и `log(gdp60)` коррелируют, но удаление `gdpgrowth` из регрессии только ухудшает значимость, поэтому убирать его не будем. `invest` и `school`, в свою очередь, **можно убрать**, так как они не значимы при любых стандартных уровнях значимости.

```{r}
lm.df.oecd <- lm.beta(lm(data = df[which(df$oecd == "yes"),], log(gdp85) ~ log(gdp60) + gdpgrowth))
summary(lm.df.oecd)
```

В данном случае p-value уменьшился, а $R^2$ уменьшился совсем немного, поэтому можем выбрать эту модель

##### Анализ остатков

Перейдём к анализу остатков.

```{r}
library(MASS) #для deleted residuals
par(mfrow = c(2, 2))
plot(lm.df.oecd, 1)
plot(lm.df.oecd, 2)
plot(lm.df.oecd, 4)
r <- stdres(lm.df.oecd)
jackknife.res <- studres(lm.df.oecd) 
plot(jackknife.res ~ r, main = "Residuals vs Deleted")
abline(coef = c(0,1))
```

На первом графике, на котором показаны предсказания $\hat{\mathbf{y}}$ (по оси $x$) и остатки $\mathbf y - \hat{\mathbf{y}}$ (по оси $y$) кажется всё не очень хорошо (видим некоторую нелинейность), но это можно объяснить тем, что у нас маленькая выборка. 

С нормальностью остатков по QQ plot всё не совсем хорошо, поэтому к результатам по критериям относимся с осторожностью: они в таком случае асимптотические, а выборка у нас здесь маленькая. 

На третьем графике видим, что есть пара кандидатов на аутлаер по распределению (по Куку). Один из критериев для нахождения таких аутлаеров — превышение среднего значения расстояния по Куку в четуре раза. Этому условию соответствуют наблюдения 89 и 53. Если убрать их, у нас станет меньше наблюдений и к тому же появятся новые аутлаеры по Куку . 

**Когда остановиться? — я не знаю**

#TODO: узнать что за страны и посмотреть в чём может быть проблема

```{r}
lm.df.oecd <- lm.beta(lm(data = df[which(df$oecd == "yes" & df$X != 89 & df$X != 53),], log(gdp85) ~ log(gdp60) + gdpgrowth))
summary(lm.df.oecd)
```

Значимость уменьшилась для регрессии в целом и для двух коэффициентов в частности. 

Еще раз можем посмотреть на графики по остаткам.

```{r}
library(MASS) #для deleted residuals
par(mfrow = c(2, 2))
plot(lm.df.oecd, 1)
plot(lm.df.oecd, 2)
plot(lm.df.oecd, 4)
r <- stdres(lm.df.oecd)
jackknife.res <- studres(lm.df.oecd) 
plot(jackknife.res ~ r, main = "Residuals vs Deleted")
abline(coef = c(0,1))
```

Первая картинка выглядит чуть более гетероскедастичной, QQ plot практически не поменялся, добавилось несколько новых аутлаеров по Куку, хоть расстояния Кука в целом значительно уменьшились. Лучше стал выглядеть график удалённых остатков.

Я бы оставил предыдущую модель без удаления аутлаеров.

##### Попытка предсказания

Попробуем предсказать ВВП для страны которая 


#### Не члены ОЭСР

```{r}
lm.df.oecd <- lm(data = df[which(df$oecd == "no"),], log(gdp85) ~ log(gdp60) + gdpgrowth + invest + school)
summary(lm.df.oecd)
```



Изучаете результат. В частности, значима ли регрессия (т.е. имеет ли смысл ей пользоваться для предсказания). Смотрите на коэффициенты регрессии, их значимость, их интерпретацию.
Далее есть три проблемы, из-за которых результаты регрессии могут быть неправильными – линейная модель регрессии не соответствует данным, в данных могут быть сильно зависимые «независимые» переменные и также могут быть outliers. Если данные были предварительно хорошо подготовлены, то проблемы с outliers там менее вероятны. Поэтому сначала можно заняться проблемой зависимости. В общем случае, нет строгой рекомендации, в каком порядке нужно решать перечисленные проблемы.
Надо учесть проблему, которая возникают, если предикторы сильно зависимы. На примере с двумя «независимыми» признаками пишете формулы и показываете, как корреляция между признаками влияет на качество оценок регрессии.
Пытаетесь уменьшить количество предикторов. Для этого есть информационные критерии AIC, BIC.
Строите обычную регрессию по выбранному числу признаков. Изучаете остатки (residuals), распределение, Сначала смотрите на нормальность остатков (зачем нужно на это смотреть?), затем можно посмотреть на зависимость Residuals vs Predicted.
Далее переходите к поиску outliers. Напоминаю, что выброс по отношению к регрессии - это наблюдение, которое влияет на результат (leverage и Cook distance изменяют то, насколько наблюдение влияет).


Итог: результат линейной регрессии, для которой проверена адекватность модели, значимость, отсутствие outliers, проинтерпретированы коэффициенты регрессии.
Спрогнозируйте что-нибудь по построенной регрессионной модели. Постройте доверительный и предсказательный интервалы для предсказания.




